name: Label issues
on:
  issues:
    types:
      - reopened
      - opened
jobs:
  label_issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Get Existing Labels
        id: get_labels
        run: |
          LABELS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                    -H "Accept: application/vnd.github.v3+json" \
                    https://api.github.com/repos/${{ github.repository }}/labels \
                    | jq -r '.[].name')
          echo "$LABELS"
          echo "name=$LABELS" >> $GITHUB_OUTPUT
      - name: Check for Keywords and Set Labels
        run: |
          EXISTING_LABELS="${{ steps.get_labels.outputs.labels }}"
          LABELS=""
          for label in $EXISTING_LABELS; do
              if grep -q "$label" <<< "${{ github.event.issue.title }}"; then
                  # Append label to LABELS variable
                  LABELS="$LABELS,$label"
              fi
          done
          # Remove leading comma if LABELS is not empty
          if [ -n "$LABELS" ]; then
              LABELS="${LABELS#,}"
              # Set labels to the issue
              gh issue edit ${{ github.event.issue.number }} --add-label "$LABELS"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          NUMBER: ${{ github.event.issue.number }}
          LABELS: triage
